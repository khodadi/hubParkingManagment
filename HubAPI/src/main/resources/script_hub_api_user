CREATE SCHEMA hub_api AUTHORIZATION hub_api_user;

CREATE SEQUENCE  hub_api.machine_reader_seq
    START 1000
    INCREMENT 1
    MINVALUE 1000   MAXVALUE 999999999999
    CACHE 20 CYCLE;



CREATE TABLE hub_api.MACHINE_READER (
        MACHINE_READER_ID     int PRIMARY KEY,
        IDENTIFIER_CODE       varchar(8) NOT NULL,
        PARKING_LOT_CODE      varchar(12) ,
        USER_ID               int,
        FINE_CODE             varchar(4) ,
        MACHINE_CODE          varchar(8) ,
        LOCATION_LATITUDE     int8 ,
        LOCATION_LONGITUDE    int8,
        READER_DATE_TIME      date ,
        API_DATE_TIME         date,
        GPS_ERROR             float4
);




WITH RECURSIVE generation AS (
    SELECT  f.fine_code_id,f.fine_code, f.fine_description, f.fine_abbreviation,f.parent_id, 1 AS level
    FROM   hub_api.fine_code f
    where f.fine_code = CASE WHEN LENGTH('7777') = 0  THEN f.fine_code
                             ELSE '7777'
                        END
         and
        f.fine_abbreviation = CASE WHEN LENGTH('') = 0  THEN f.fine_abbreviation
                                   ELSE '7777'
                              END
    UNION  ALL
    SELECT  child.fine_code_id,child.fine_code, child.fine_description, child.fine_abbreviation,child.parent_id, g.level + 1 AS level
    FROM  hub_api.fine_code child
               JOIN  generation g   ON child.parent_id = g.fine_code_id

)
select * from generation
